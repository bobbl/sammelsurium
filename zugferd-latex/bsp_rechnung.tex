\DocumentMetadata{pdfstandard=a-3b,lang=de}
\documentclass[version=last,fontsize=12pt,footheight=30mm,DIV=15]{scrlttr2}
\LoadLetterOption{DINmtext}

\usepackage[ngerman]{babel}
\usepackage[utf8]{inputenc}
\usepackage[gen]{eurosym}
\usepackage[format=xrechnung3.0]{my_rechnung}


% use current date
%\newcommand{\InvoiceYear}{\the\year}
%\newcommand{\InvoiceMonth}{\ifnum\the\month<10 0\fi\the\month}
%\newcommand{\InvoiceDay}{\ifnum\the\day<10 0\fi\the\day}
\newcommand{\InvoiceYear}{2024} % must be 4 digits
\newcommand{\InvoiceMonth}{05}  % must be 2 digits (leading zero)
\newcommand{\InvoiceDay}{01}    % must be 2 digits (leading zero)

\newcommand{\InvoiceNo}{6667}    % must be 2 digits (leading zero)


\newcommand{\BuyerName}{Kevin Käufer}
\newcommand{\BuyerAddress}{Kundenstraße 17}
\newcommand{\BuyerPostcode}{11111}
\newcommand{\BuyerCity}{Musterstadt}
\newcommand{\BuyerCountry}{DE}
\newcommand{\BuyerEmail}{kaeufer@email.de}
\newcommand{\BuyerVatid}{}
\newcommand{\BuyerReference}{1} % Leitweg-ID

\newcommand{\SellerName}{Verena Verkäuferin}
\newcommand{\SellerAddress}{Verkaufsstraße 3}
\newcommand{\SellerPostcode}{55555}
\newcommand{\SellerCity}{Verkaufsstadt}
\newcommand{\SellerCountry}{DE}
\newcommand{\SellerPhone}{+49 111 22 33 44 55}
\newcommand{\SellerEmail}{verkaeuferin@musterfirma.de}
\newcommand{\SellerUrl}{https://www.musterfirma.de}
\newcommand{\SellerVatid}{DE123456789}
\newcommand{\SellerAccountHolder}{\SellerName}
\newcommand{\SellerIban}{DE68 2105 0170 0012 3456 78}
\newcommand{\SellerBic}{MUSTERBICXX}


%\setkomavar{fromemail}{verkaeuferin@musterfirma.de}
%\setkomavar{fromphone}{+49 111 22 33 44 55}
%\usekomavar[\newcommand\SellerPhone]{fromphone}
%\usekomavar[\newcommand\SellerEmail]{fromemail}

\setkomavar{yourref}[Ihre Bestellung vom]{01.04.2024}

\setkomavar{fromname}{\SellerName}
\setkomavar{fromaddress}{\SellerAddress\\\SellerPostcode\ \SellerCity}
\setkomavar{invoice}{\InvoiceNo}
\setkomavar{date}{\InvoiceDay.\InvoiceMonth.\InvoiceYear}
\setkomavar{subject}{Beispielrechnung mit zugferd}
\setkomavar{signature}{\SellerName}





\DeclareUnicodeCharacter{20AC}{\euro} % damit sieht das €-Symbol besser aus

\makeatletter
  \addtoplength{firstfootvpos}{-50mm} % Fußnote nach oben ziehen
  %\setplength{refvpos}{70mm} % Rechnungsnummerzeile nach oben ziehen
\makeatother
%\setplength{refwidth}{170mm}
%\setplength{refhpos}{15mm}

\setkomavar{firsthead}{%
  \raggedleft{\Huge\selectfont\scshape 
    Musterfirma
  }
}

\setkomavar{firstfoot}{%
  \parbox[t]{\textwidth}{\footnotesize
  \begin{tabular}[t]{l@{}}%
    \SellerName\\
    \SellerAddress\\
    \SellerPostcode\ \SellerCity\\
    \SellerCountry % TODO: convert to full name
  \end{tabular}%
  \hfill
  \begin{tabular}[t]{l@{}}%
    \usekomavar*{fromphone}\usekomavar{fromphone}\\
    \usekomavar*{fromemail}\usekomavar{fromemail}\\
    \usekomavar*{fromurl} \SellerUrl\\
    USt-IdNr. \SellerVatid\\
  \end{tabular}%
  \hfill
  \begin{tabular}[t]{l@{}}%
    Kontoinhaber: \SellerAccountHolder\\
    IBAN: \SellerIban\\
    BIC: \SellerBic
  \end{tabular}%
}}







%\newcommand\SetZugferdKoma[2]{\SetZUGFeRDData{#1=#2}}
%\usekomavar[\SetZugferdKoma{seller/email}]{fromemail}



\SetZUGFeRDData{
  %document-type =  commercial-invoice,
  id              = komavar,
  date            = {\InvoiceYear\InvoiceMonth\InvoiceDay},
  %delivery-date   = auto,
  subject         = komavar,
  fromaddress     = komavar,
  %tax/category    = S,
  tax/rate        = 19,
  unit            = hour,
  seller/name     = \SellerName,
  seller/postcode = \SellerPostcode,
  seller/city     = \SellerCity,
  seller/country  = \SellerCountry,
  seller/address  = \SellerAddress,
  seller/vatid    = \SellerVatid,
  seller/contact  = {\SellerName\\\SellerPhone\\\SellerEmail},
    % required: BT-41 (Seller contact point)
    %           BT-42 (Seller contact telephone number)
    %           BT-43 (Seller contact email address)
  seller/email    = \SellerEmail,
  buyer/reference = \BuyerReference,
  buyer/name      = \BuyerName,
  buyer/postcode  = \BuyerPostcode,
  buyer/city      = \BuyerCity,
  buyer/country   = \BuyerCountry,
  buyer/address   = \BuyerAddress,
  %buyer/vatid     = \BuyerVatid, % muss man ganz weglassen, wenn unbekannt
  buyer/email     = \BuyerEmail,
  currency        = €,
  % Entweder payment-terms oder due-date muss vorhanden sein:
  payment-terms   = {Zahlbar innerhalb von 14 Tagen},
  %due-date        = {20241231},
  payment-means / type           = 58, % SEPA Überweisung
  payment-means / iban           = \SellerIban,
  payment-means / account-holder = \SellerAccountHolder,
  payment-means / bic            = \SellerBic
}



\begin{document}
  \begin{letter}{\BuyerName\\
      \BuyerAddress\\
      \BuyerPostcode\ \BuyerCity
    }
    \enlargethispage{6\baselineskip} % Unterschrift darf weiter nach unten
    \opening{Sehr geehrter Herr Käufer,}

    ich bedanke mich für Ihr Vertrauen und berechne folgende Leistungen:

    \AddInvoiceItem{10}{Erster Punkt}{60}
    \AddInvoiceItem{20}{Zweiter Punkt}{70}
    \AddInvoiceItem{30}{Dritter Punkt}{80}

    \PrintInvoiceTabular

    \noindent Bitte überweisen Sie den Rechnungsbetrag ohne Abzüge innerhalb
    von 14 Tagen auf mein unten angegebenes Konto.
    \closing{Mit freundlichen Grüßen}
  \end{letter}
\end{document}
